{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Question set</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="/chunks">Go to chunks (C)</a>
  </div>
</div>

<form method="get" action="/questions" class="row g-2 mb-3">
  <div class="col-md-3">
    <label class="form-label">Topic</label>
    <select class="form-select" name="topic">
      <option value="">(All)</option>
      {% for t in topics %}
        <option value="{{t}}" {% if t==topic %}selected{% endif %}>{{t}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Bucket</label>
    <select class="form-select" name="bucket">
      <option value="">(All)</option>
      {% for b in buckets %}
        <option value="{{b}}" {% if b==bucket %}selected{% endif %}>{{b}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-6">
    <label class="form-label">Search</label>
    <input class="form-control" type="text" name="q" value="{{q or ''}}" placeholder="Find question text...">
  </div>
</form>

<div class="table-responsive">
  <table class="table table-hover align-middle mb-0">
    <thead class="sticky-header">
      <tr>
        <th style="width:110px">ID</th>
        <th style="width:180px">Topic</th>
        <th style="width:110px">Bucket</th>
        <th>Question</th>
        <th style="width:240px">Chunk</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr data-qid="{{ r.id }}" onclick="selectRow('{{ r.id }}')">
        <td class="text-monospace">{{ r.id }}</td>
        <td>{{ r.topic }}</td>
        <td><span class="badge">{{ r.bucket }}</span></td>
        <td>{{ r.question }}</td>
        <td class="text-truncate" id="chunk-{{ r.id }}">{{ r.chunk or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function selectRow(qid){
    sessionStorage.setItem('gsr.current.qid', qid);
    document.dispatchEvent(new CustomEvent('gsr-select-qid', {detail:{qid}}));
    // If you prefer auto-jump, uncomment:
    // location.href = '/chunks?qid=' + encodeURIComponent(qid);
  }

  // Prev/Next hotkeys navigate rows
  const rows = [...document.querySelectorAll('tbody tr')];
  function focusBy(delta){
    if(!rows.length) return;
    const current = sessionStorage.getItem('gsr.current.qid');
    let idx = Math.max(0, rows.findIndex(r=>r.dataset.qid===current));
    idx = Math.min(rows.length-1, Math.max(0, idx + delta));
    const qid = rows[idx].dataset.qid;
    sessionStorage.setItem('gsr.current.qid', qid);
    rows[idx].scrollIntoView({block:'center'});
    rows[idx].classList.add('table-active');
    setTimeout(()=>rows[idx].classList.remove('table-active'), 400);
  }
  window.addEventListener('gsr-prev', ()=>focusBy(-1));
  window.addEventListener('gsr-next', ()=>focusBy(+1));
</script>

{% endblock %}
